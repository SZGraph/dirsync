
# Perl скрипт для продвинутой синхронизации директории

Скрипт разработан для рекурсивной синхронизации директории ПРИЕМНИКА с директорией ИСТОЧНИКА. 
Програмка будет полезна для синхронизации разрозненных личных проектов, например, при подготовке к почистке компьютера.

Файлы ИСТОЧНИКА не удаляются. Вся информация о перемещении файлов печатается в STDOUT.
Для синхронизации в обоих направлениях вызовите скрипт дважды поменяв местами параметры имени и пути к ПРИЕМНИКУ и ИСТОЧНИКУ.
Для сохранения информации о синхронизации перенаправьте вывод STDOUT в файл в консоли.

## История
Эта програмка создана под веянием *начинов* принятых в маленькой болгарской фирме, похожей на хозяйство семибаба.
Её хозяин считал, что женщины самые лучшие программисты и был горд миллионами строк написанными его командой. Моя работа иногда мне напоминала работу над школьными сочинениями. Там писали код в котором каждую строку кода **задължително** предваряет одна или несколько строк описания, не смотря на повторы. Недостатки подхода - миллионы строк.  Достоинство подхода - код может понять не специалист. И для небольшой програмки как эта, листинг подъемен для прочтения. Я здесь соблюл только часть всех тех требований.

## Запуск скрипта в консоли
`perl dirsync.pl <директория ИСТОЧНИКА> <директория ПРИЕМНИКА>`\
*Например*, ```perl dirsync.pl /home/.../.github /media/...github > dirsync_log.txt``` (Информация о синхронизации отпечатывается в файл dirsync_log.txt. Для больших прав при копировании и чтении запустите скрипт с правами администратора, например, `sudo perl dirsync.pl...`).

## Особенности dirsync.pl
Программа сравнивает файлы в ИСТОЧНИКЕ и ПРИЕМНИКЕ:
1. по имени;
2. по размеру файла;
3. по содержанию (в случае равных размеров);
4. по дате создания.

Первым приоритетом для синхронизации обладает имя файла. Если в ПРИЕМНИКЕ нет файла или директории с тем же именем, что и в ИСТОЧНИКЕ то они целиком копируются в ПРИЕМНИК.\
Второй приоритет у размера файла. Если файлы равны, то они сравниваются по содержанию (актуально для случаев где в файле изменен параметр, цифра). Если содержания файла ИСТОЧНИКА и ПРИЕМНИКА идентичны, то копирование не произойдет. Заметим, что сравнение файлов ограничено по-умолчанию первыми 25 МБ (может быть изменена через переменную `$PARAM_s_bytes_compare`\*). Так же, через переменную `$PARAM_s_ignore_bytes_compare`\* можно задать количество первых байт которые не будут участвовать в сравнении (по умолчанию 0).\
Если файлы не равны по размеру или содержанию, то учитывается время создания файлов.
В зависимости от времени создания файлов ИСТОЧНИКА и ПРИЕМНИКА выполняется одно из действий:
-   Если в ПРИЕМНИКЕ более старый файл, то к его имени добавляется ЗАДАННЫЙ пользователем суффикс перед расширением файла 
	 (параметр $PARAM_s_suffix_old_file*). Файл ИСТОЧНИКА копируется с сохранением своего имени.
    Если файл в ИСТОЧНИКЕ будет снова изменен и синхронизирован, то предыдущий перемещенный файл ИСТОЧНИКА с идентичным именем будет 
    переименован с добавлением порядкового номера к суффиксу.
-   Если в ИСТОЧНИКЕ более старый файл, то он копируется с сохранением своего имени в архивную директорию с ЗАДАННЫМ пользователем именем 
	 (параметр $PARAM_s_archive_dir_name*) рядом с файлом ПРИЕМНИКА.
    Если файл в ПРИЕМНИКЕ будет изменен и синхронизирован, при этом файл в ИСТОЧНИКЕ окажется не совпадающим с файлом из архивной директории, 
    то файл из архивной директории получит к имени суффикс и свой порядковый номер.
    

## Пользовательские настройки синхронизации ПРИЕМНИКА
Вы можете отсеять ненужные файлы ИСТОЧНИКА при синхронизации. Для этого в список `@PARAM_a_nonsinchronize_elements`\* добавьте своё регулярное выражение 'regex', отвечающее имени непредназначенного для синхронизации файла. 'regex' будет применено к именам файлов каждой директории ИСТОЧНИКА.
Синхроницация файлов ПРИЕМНИКА осуществляется по следующим правилам.\
Копирование файлов и директорий осуществляется внутри двух функций (`$file_copy_sub` и `$dir_copy_sub`), которые вынесены для удобства настроек в раздел НАСТРАИВАЕМЫЕ ФУНКЦИИ КОПИРОВАНИЯ. Настройки можно корректировать изменением параметров функций `zip` и `tar`.\
Копирование осуществляется путем конвеерного архивирования файла в STDOUT и разархивирования в нужную директорию с сохранением прав доступа и времени создания файлов.

\**Примечание*. Переменные через которые задаются помеченные \* настройки собраны в разделе НАСТРАИВАЕМЫЕ ПАРАМЕТРЫ.

## Зависимости программы dirsync.pl
Скрипт написан на perl v5.32.1
Скрипт использует системные функции cmp, mkdir, zip, tar, zcat и адаптирован под следующие версиии:
-   `cmp` (GNU coreutils) 8.32 - для сравнения файлов;
-   `mkdir`  (GNU coreutils) 8.32 - для создания каталогов;
-   `zip` 3.0 (July 5th 2008) - для создания zip архивов;
-   `tar` (GNU tar) 1.34 - для работы tar архивами;
-   `zcat` (gzip) 1.10 - для разархивирования из STDOUT.\
C другими версиями данных программ работоспособность скрипта не проверялась.
